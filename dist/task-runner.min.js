!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.tr=e()}(this,function(){var t;!function(t){var e=function(){function e(r){if(this.name_=r,this.state_=t.enums.State.INITIALIZED,this.taskCallbackMap_={},this.uniqueID_=e.UNIQUE_ID_COUNTER++,window.DEBUG){var s=new Error("Constructor");if(s.hasOwnProperty("stack")){var i=s.stack;this.creationContext_=i.replace(/^\s+at\s+/gm,"").replace(/\s$/gm,"").split("\n").slice(2)}this.logger_=console.log}else this.logger_=function(){}}return e.prototype.log=function(t){this.logger_.call(console,t+" :: "+this)},e.prototype.toString=function(){return this.name_+" [id: "+this.uniqueID_+"]"},e.prototype.getCompletedOperationsCount=function(){return this.state_===t.enums.State.COMPLETED?1:0},e.prototype.getCreationContext=function(){return this.creationContext_},e.prototype.getData=function(){return this.data_},e.prototype.getErrorMessage=function(){return this.errorMessage_},e.prototype.getName=function(){return this.name_},e.prototype.getOperationsCount=function(){return 1},e.prototype.getState=function(){return this.state_},e.prototype.getUniqueID=function(){return this.uniqueID_},e.prototype.completed=function(e,r){return this.on(t.enums.Event.COMPLETED,e,r)},e.prototype.errored=function(e,r){return this.on(t.enums.Event.ERRORED,e,r)},e.prototype["final"]=function(e,r){return this.on(t.enums.Event.FINAL,e,r)},e.prototype.interrupt=function(){if(this.state_!=t.enums.State.RUNNING)throw Error("Cannot interrupt a task that is not running.");return this.log("Interrupting"),this.state_=t.enums.State.INTERRUPTED,this.interruptImpl(),this.executeCallbacks(t.enums.Event.INTERRUPTED),this},e.prototype.interrupted=function(e,r){return this.on(t.enums.Event.INTERRUPTED,e,r)},e.prototype.interruptFor=function(e){this.log("Interrupting for "+e),this.interruptingTask_=e,this.interrupt();var r=this;return e.completed(function(t){t==r.interruptingTask_&&(r.interruptingTask_=null,r.run())},this),e.errored(function(e){e==r.interruptingTask_&&(r.interruptingTask_=null,r.state_=t.enums.State.RUNNING,r.errorInternal(e.getData(),e.getErrorMessage()))},this),this},e.prototype.off=function(t,e,r){this.taskCallbackMap_[t]=this.taskCallbackMap_[t]||[];for(var s=this.taskCallbackMap_[t],i=0,n=s.length;n>i;i++){var o=s[i];if(o.matches(e,r))return s.splice(i,1),this}return this},e.prototype.on=function(t,e,s){this.taskCallbackMap_[t]=this.taskCallbackMap_[t]||[];for(var i=this.taskCallbackMap_[t],n=0,o=i.length;o>n;n++){var a=i[n];if(a.matches(e,s))return this}return i.push(new r(e,s)),this},e.prototype.reset=function(){if(this.state_==t.enums.State.RUNNING)throw Error("Cannot reset a running task.");return this.log("Resetting"),this.state_!=t.enums.State.INITIALIZED&&(this.data_=void 0,this.errorMessage_=void 0,this.state_=t.enums.State.INITIALIZED,this.resetImpl()),this},e.prototype.run=function(){if(this.state_==t.enums.State.RUNNING)throw Error("Cannot run a running task.");return this.log("Running"),this.state_!=t.enums.State.COMPLETED&&(this.interruptingTask_=null,this.data_=void 0,this.errorMessage_=void 0,this.state_=t.enums.State.RUNNING,this.executeCallbacks(t.enums.Event.STARTED),this.runImpl()),this},e.prototype.started=function(e,r){return this.on(t.enums.Event.STARTED,e,r)},e.prototype.completeInternal=function(e){if(this.state_!==t.enums.State.RUNNING)throw"Cannot complete an inactive task.";this.log("Internal complete"),this.data_=e,this.state_=t.enums.State.COMPLETED,this.executeCallbacks(t.enums.Event.COMPLETED),this.executeCallbacks(t.enums.Event.FINAL)},e.prototype.errorInternal=function(e,r){if(this.state_!=t.enums.State.RUNNING)throw"Cannot error an inactive task.";this.log("Internal error"),this.data_=e,this.errorMessage_=r,this.state_=t.enums.State.ERRORED,this.executeCallbacks(t.enums.Event.ERRORED),this.executeCallbacks(t.enums.Event.FINAL)},e.prototype.executeCallbacks=function(t){var e=this.taskCallbackMap_[t];if(e)for(var r=0,s=e.length;s>r;r++)e[r].execute(this)},e.prototype.interruptImpl=function(){},e.prototype.resetImpl=function(){},e.prototype.runImpl=function(){throw Error("Required methods runImpl() not implemented.")},e.UNIQUE_ID_COUNTER=0,e}();t.Abstract=e;var r=function(){function t(t,e){this.callback_=t,this.scope_=e}return t.prototype.execute=function(t){this.scope_?this.callback_.call(this.scope_,t):this.callback_(t)},t.prototype.matches=function(t,e){return this.callback_===t&&this.scope_===e},t}()}(t||(t={}));var t,e=this.__extends||function(t,e){function r(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);r.prototype=e.prototype,t.prototype=new r};!function(t){var r=function(r){function s(e,s,i){r.call(this,i||"Chain"),this.mostRecentTaskArgs_=[],this.graph_=new t.Graph,this.graph_.completed(this.completeInternal.bind(this)),this.graph_.errored(this.errorInternal.bind(this)),void 0!==e&&this.completed(e),void 0!==s&&this.errored(s)}return e(s,r),s.prototype["else"]=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return this.or.apply(this,t)},s.prototype.first=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];if(this.graph_.getOperationsCount()>0)throw Error("Cannot call first after tasks have been added");return this.then.apply(this,t),this},s.prototype.getDecoratedTask=function(){return this.graph_},s.prototype.or=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];this.graph_.removeAll(this.mostRecentTaskArgs_);var s=new t.StopOnSuccess;return s.add(new t.Composite(!0,this.mostRecentTaskArgs_)),s.add(e.length>1?new t.Composite(!0,e):e[0]),this.graph_.addToEnd(s),this.mostRecentTaskArgs_=[s],this},s.prototype.otherwise=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return this.or.apply(this,t)},s.prototype.then=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return this.mostRecentTaskArgs_=t,this.graph_.addAllToEnd(t),this},s.prototype.getOperationsCount=function(){return this.graph_.getOperationsCount()},s.prototype.getCompletedOperationsCount=function(){return this.graph_.getCompletedOperationsCount()},s.prototype.runImpl=function(){this.graph_.run()},s.prototype.interruptImpl=function(){this.graph_.interrupt()},s.prototype.resetImpl=function(){this.graph_.reset()},s}(t.Abstract);t.Chain=r}(t||(t={}));var t;!function(t){var r=function(r){function s(t,e,s){r.call(this,s||"Closure"),this.runImplFn_=t,this.autoCompleteUponRun_=!!e}return e(s,r),s.prototype.runImpl=function(){try{this.runImplFn_(this),this.autoCompleteUponRun_&&this.getState()===t.enums.State.RUNNING&&this.completeInternal()}catch(e){this.getState()===t.enums.State.RUNNING&&this.errorInternal(e,e.message)}},s.prototype.complete=function(t){this.completeInternal(t)},s.prototype.error=function(t,e){this.errorInternal(t,e)},s}(t.Abstract);t.Closure=r}(t||(t={}));var t;!function(t){var r=function(r){function s(t,e,s){r.call(this,s||"Composite"),this.completedTasks_=[],this.erroredTasks_=[],this.taskQueue_=[],this.taskQueueIndex_=0,this.parallel_=t,e&&this.addAll(e)}return e(s,r),s.prototype.add=function(e){var r=this.taskQueue_.indexOf(e);if(r>=0)throw Error("Cannot add task more than once.");return this.taskQueue_.push(e),this.getState()==t.enums.State.RUNNING&&(r=this.taskQueue_.indexOf(e),(this.parallel_||this.taskQueueIndex_==r)&&(this.addCallbacks_(e),e.run())),this},s.prototype.addAll=function(t){for(var e=0;e<t.length;e++)this.add(t[e]);return this},s.prototype.remove=function(e){var r=this.taskQueue_.indexOf(e);if(0>r)throw Error("Attempted to remove an invalid task.");return this.removeCallbacks_(e),this.taskQueue_.splice(this.taskQueue_.indexOf(e),1),this.getState()==t.enums.State.RUNNING&&((this.parallel_||r<=this.taskQueueIndex_)&&this.taskQueueIndex_--,(e.getState()==t.enums.State.RUNNING||e.getState()==t.enums.State.INTERRUPTED)&&this.taskCompletedOrRemoved_(e)),this},s.prototype.getCompletedOperationsCount=function(){var t=0;return this.eachTaskInQueue_(function(e){t+=e.getCompletedOperationsCount()}),t},s.prototype.getOperationsCount=function(){var t=0;return this.eachTaskInQueue_(function(e){t+=e.getOperationsCount()}),t},s.prototype.interruptImpl=function(){this.eachTaskInQueue_(function(e){e.getState()==t.enums.State.RUNNING&&e.interrupt()})},s.prototype.resetImpl=function(){this.taskQueueIndex_=0,this.completedTasks_=[],this.erroredTasks_=[],this.eachTaskInQueue_(function(t){t.reset()})},s.prototype.runImpl=function(){if(this.allTasksAreCompleted_())this.completeInternal();else if(this.erroredTasks_=[],this.parallel_)this.eachTaskInQueue_(function(e){this.getState()===t.enums.State.RUNNING&&(this.addCallbacks_(e),e.run())}.bind(this));else{var e=this.taskQueue_[this.taskQueueIndex_];this.addCallbacks_(e),e.run()}},s.prototype.addCallbacks_=function(t){t.completed(this.childTaskCompleted_,this),t.errored(this.childTaskErrored_,this)},s.prototype.allTasksAreCompleted_=function(){for(var e=0;e<this.taskQueue_.length;e++){var r=this.taskQueue_[e];if(r.getState()!=t.enums.State.COMPLETED)return!1}return!0},s.prototype.checkForTaskCompletion_=function(){if(!this.flushQueueInProgress_){var t=this.completedTasks_.length+this.erroredTasks_.length;t>=this.taskQueue_.length&&(this.erroredTasks_.length>0?this.errorInternal():this.completeInternal())}},s.prototype.childTaskCompleted_=function(t){this.completedTasks_.push(t),this.taskCompletedOrRemoved_(t)},s.prototype.childTaskErrored_=function(t){this.erroredTasks_.push(t),this.parallel_?this.checkForTaskCompletion_():this.errorInternal(t.getData(),t.getErrorMessage())},s.prototype.eachTaskInQueue_=function(t){for(var e=0;e<this.taskQueue_.length;e++){var r=this.taskQueue_[e];t(r)}},s.prototype.flushQueue=function(e){for(this.flushQueueInProgress_=!!e,this.eachTaskInQueue_(function(e){e.getState()==t.enums.State.RUNNING&&e.interrupt()});this.taskQueue_.length>0;){var r=this.taskQueue_[this.taskQueue_.length-1];this.remove(r)}this.completedTasks_=[],this.erroredTasks_=[],this.flushQueueInProgress_=!1},s.prototype.removeCallbacks_=function(e){e.off(t.enums.Event.COMPLETED,this.childTaskCompleted_,this),e.off(t.enums.Event.ERRORED,this.childTaskErrored_,this)},s.prototype.taskCompletedOrRemoved_=function(){if(this.taskQueueIndex_++,this.getState()==t.enums.State.RUNNING&&(this.checkForTaskCompletion_(),!this.parallel_&&this.getState()==t.enums.State.RUNNING)){var e=this.taskQueue_[this.taskQueueIndex_];e&&(this.addCallbacks_(e),e.run())}},s}(t.Abstract);t.Composite=r}(t||(t={}));var t;!function(t){var r=function(r){function s(t){r.call(this,t||"Graph"),this.erroredTasks_=[],this.taskIdToDependenciesMap_={},this.tasks_=[]}return e(s,r),s.prototype.add=function(t,e){return this.addAll([t],e)},s.prototype.addAll=function(e,r){for(var s=0,i=e.length;i>s;s++){var n=e[s];if(this.tasks_.indexOf(n)>=0)throw Error("Cannot add task more than once.");this.tasks_.push(n),this.updateBlockers_([n],r),this.validateDependencies_(n)}return this.getState()==t.enums.State.RUNNING&&this.runAllReadyTasks_(),this},s.prototype.addToEnd=function(t){return this.add(t,this.tasks_.slice(0))},s.prototype.addAllToEnd=function(t){return this.addAll(t,this.tasks_.slice(0))},s.prototype.addBlockersTo=function(t,e){return this.updateBlockers_(e,t),this},s.prototype.remove=function(t){return this.removeAll([t])},s.prototype.removeAll=function(e){this.verifyInGraph_(e,"Cannot remove tasks not in graph.");for(var r=0,s=e.length;s>r;r++){var i=e[r];this.removeCallbacksFrom_(i),this.tasks_.splice(this.tasks_.indexOf(i),1),delete this.taskIdToDependenciesMap_[i.getUniqueID()]}for(var r=0,s=this.tasks_.length;s>r;r++)this.validateDependencies_(this.tasks_[r]);return this.getState()==t.enums.State.RUNNING&&this.completeOrRunNext_(),this},s.prototype.removeBlockersFrom=function(e,r){this.verifyInGraph_(e,"Cannot remove blockers not in graph."),this.verifyInGraph_(r,"Cannot remove tasks not in graph.");for(var s=this.taskIdToDependenciesMap_,i=0,n=r.length;n>i;i++){for(var o=r[i],a=s[o.getUniqueID()]||[],i=0,n=e.length;n>i;i++){var h=e[i],u=a.indexOf(h);u>=0&&a.splice(u,1)}s[o.getUniqueID()]=a}return this.getState()===t.enums.State.RUNNING&&this.completeOrRunNext_(),this},s.prototype.getOperationsCount=function(){var t=0;for(var e in this.tasks_)t+=this.tasks_[e].getOperationsCount();return t},s.prototype.getCompletedOperationsCount=function(){var t=0;for(var e in this.tasks_)t+=this.tasks_[e].getCompletedOperationsCount();return t},s.prototype.runImpl=function(){this.erroredTasks_=[],this.beforeFirstRunInvoked_||(this.beforeFirstRun(),this.beforeFirstRunInvoked_=!0),this.completeOrRunNext_()},s.prototype.interruptImpl=function(){for(var e in this.tasks_){var r=this.tasks_[e];r.getState()==t.enums.State.RUNNING&&(this.removeCallbacksFrom_(r),r.interrupt())}},s.prototype.resetImpl=function(){this.erroredTasks_=[];for(var t in this.tasks_)this.tasks_[t].reset()},s.prototype.beforeFirstRun=function(){},s.prototype.addCallbacksTo_=function(t){t.completed(this.childTaskCompleted_,this),t.errored(this.childTaskErrored_,this)},s.prototype.areAllTasksCompleted_=function(){for(var e in this.tasks_)if(this.tasks_[e].getState()!=t.enums.State.COMPLETED)return!1;return!0},s.prototype.childTaskCompleted_=function(t){this.removeCallbacksFrom_(t),this.completeOrRunNext_()},s.prototype.childTaskErrored_=function(t){this.removeCallbacksFrom_(t),this.erroredTasks_.push(t),this.completeOrRunNext_()},s.prototype.completeOrRunNext_=function(){if(this.getState()===t.enums.State.RUNNING)if(this.areAllTasksCompleted_())this.completeInternal();else if(0==this.erroredTasks_.length)this.runAllReadyTasks_();else{for(var e in this.tasks_){var r=this.tasks_[e];r.getState()===t.enums.State.RUNNING&&r.interrupt()}this.errorInternal()}},s.prototype.hasIncompleteBlockers_=function(e){var r=this.taskIdToDependenciesMap_[e.getUniqueID()];if(r)for(var s in r){var i=r[s];if(i.getState()!=t.enums.State.COMPLETED)return!0}return!1},s.prototype.isAnyTaskRunning_=function(){for(var e in this.tasks_)if(this.tasks_[e].getState()==t.enums.State.RUNNING)return!0;return!1},s.prototype.removeCallbacksFrom_=function(e){e.off(t.enums.Event.COMPLETED,this.childTaskCompleted_,this),e.off(t.enums.Event.ERRORED,this.childTaskErrored_,this)},s.prototype.runAllReadyTasks_=function(){for(var e in this.tasks_){var r=this.tasks_[e];if(this.getState()!==t.enums.State.RUNNING)return;this.erroredTasks_.indexOf(r)>=0||this.hasIncompleteBlockers_(r)||r.getState()!=t.enums.State.RUNNING&&r.getState()!=t.enums.State.COMPLETED&&(this.addCallbacksTo_(r),r.run())}},s.prototype.updateBlockers_=function(e,r){if(r&&0!==r.length){this.verifyInGraph_(e,"Cannot add blockers to tasks not in graph."),this.verifyInGraph_(r,"Cannot block on tasks not in graph.");for(var s=0,i=e.length;i>s;s++){var n=e[s];if(n.getState()!==t.enums.State.INITIALIZED)throw Error("Cannot add blocking dependency to running task.");for(var o=this.taskIdToDependenciesMap_[n.getUniqueID()]||[],s=0,i=r.length;i>s;s++){var a=r[s];o.indexOf(a)<0&&o.push(a)}this.taskIdToDependenciesMap_[n.getUniqueID()]=o}}},s.prototype.validateDependencies_=function(t){var e=this.taskIdToDependenciesMap_[t.getUniqueID()];if(e){if(e.indexOf(t)>=0)throw Error("Cyclic dependency detected.");this.verifyInGraph_(e,"Task depends on blocker that is not in the graph")}},s.prototype.verifyInGraph_=function(t,e){for(var r=0,s=t.length;s>r;r++)if(this.tasks_.indexOf(t[r])<0)throw Error(e)},s}(t.Abstract);t.Graph=r}(t||(t={}));var t;!function(t){var r=function(r){function s(t,e){r.call(this,e||"Conditional"),this.conditionIdsToFailsafeWrappersMap_={},this.conditions_=[],this.prioritizedOutcomes_=[],this.taskIdToBlockingTasksMap_={},this.chooseFirstAvailableOutcome_=!!t}return e(s,r),s.prototype.getChosenOutcome=function(){return this.chosenOutcome_},s.prototype.addOutcome=function(e,r){r=r||[],this.prioritizedOutcomes_.push(e),this.taskIdToBlockingTasksMap_[e.getUniqueID()]=r;for(var s=0,i=r.length;i>s;s++){var n=r[s];if(!(this.conditions_.indexOf(n)>=0)){this.chooseFirstAvailableOutcome_&&n.completed(this.maybeChooseEarlyOutcome_,this);var o=new t.Failsafe(n);this.conditionIdsToFailsafeWrappersMap_[n.getUniqueID()]=o,this.conditions_.push(n),this.add(o)}}return this},s.prototype.allConditionsHaveCompleted_=function(){this.chooseOutcomeIfValid_(),this.chosenOutcome_?this.addToEnd(this.chosenOutcome_):this.errorInternal("No valid outcomes found.")},s.prototype.beforeFirstRun=function(){this.allConditionsHaveCompletedClosure_=new t.Closure(this.allConditionsHaveCompleted_.bind(this),!0,"Outcome-choosing-Closure"),this.addToEnd(this.allConditionsHaveCompletedClosure_)},s.prototype.chooseOutcomeIfValid_=function(){for(var e=0;e<this.prioritizedOutcomes_.length;e++){for(var r=this.prioritizedOutcomes_[e],s=this.taskIdToBlockingTasksMap_[r.getUniqueID()],i=!0,n=0;n<s.length;n++){var o=s[n];if(o.getState()===t.enums.State.ERRORED){i=!1;break}}if(i)return void(this.chosenOutcome_=r)}},s.prototype.maybeChooseEarlyOutcome_=function(){if(this.chooseOutcomeIfValid_(),this.chosenOutcome_){var e=new t.Stub;this.add(e),this.remove(this.allConditionsHaveCompletedClosure_);for(var r=0,s=this.conditions_.length;s>r;r++){var i=this.conditions_[r];i.getState()===t.enums.State.RUNNING&&(i.off(t.enums.Event.COMPLETED,this.maybeChooseEarlyOutcome_,this),i.interrupt());var n=this.conditionIdsToFailsafeWrappersMap_[i.getUniqueID()];this.remove(n)}this.add(this.chosenOutcome_),this.remove(e)}},s}(t.Graph);t.Conditional=r}(t||(t={}));var t;!function(t){var r=function(t){function r(e,r){if(t.call(this,r||"Decorator"),this.decorated_=e,!this.isFunction_("run"))throw Error("Required method run() not implemented.")}return e(r,t),r.prototype.getDecorated=function(){return this.decorated_},r.prototype.runImpl=function(){this.decorated_.run(this.complete_.bind(this),this.error_.bind(this))},r.prototype.interruptImpl=function(){this.isFunction_("interrupt")&&this.decorated_.interrupt()},r.prototype.resetImpl=function(){this.isFunction_("reset")&&this.decorated_.reset()},r.prototype.complete_=function(t){this.completeInternal(t)},r.prototype.error_=function(t,e){this.errorInternal(t,e)},r.prototype.isFunction_=function(t){return this.decorated_.hasOwnProperty(t)&&"function"==typeof this.decorated_[t]},r}(t.Abstract);t.Decorator=r}(t||(t={}));var t;!function(t){var r=function(r){function s(t,e,s,i){r.call(this,i||"Factory"),this.recreateDeferredTaskAfterError_=!1,this.deferredTaskErrored_=!1,this.argsArray_=s,this.taskFactoryFn_=t,this.thisArg_=this}return e(s,r),s.prototype.getDecoratedTask=function(){return this.deferredTask_},s.prototype.recreateDeferredTaskAfterError=function(t){this.recreateDeferredTaskAfterError_=t},s.prototype.resetImpl=function(){this.removeCallbacks_(),this.deferredTask_&&(this.deferredTask_=null)},s.prototype.interruptImpl=function(){this.deferredTask_&&(this.removeCallbacks_(),this.deferredTask_.interrupt())},s.prototype.runImpl=function(){(!this.deferredTask_||this.recreateDeferredTaskAfterError_&&this.deferredTaskErrored_)&&(this.deferredTask_=this.thisArg_?this.taskFactoryFn_.apply(this.thisArg_,this.argsArray_||[]):this.taskFactoryFn_()),this.deferredTask_.getState()==t.enums.State.COMPLETED?this.onDeferredTaskCompleted_(this.deferredTask_):this.deferredTask_.getState()==t.enums.State.ERRORED?this.onDeferredTaskErrored_(this.deferredTask_):(this.deferredTask_.completed(this.onDeferredTaskCompleted_,this),this.deferredTask_.errored(this.onDeferredTaskErrored_,this),this.deferredTask_.interrupted(this.onDeferredTaskInterrupted_,this),this.deferredTask_.run())},s.prototype.onDeferredTaskCompleted_=function(t){this.removeCallbacks_(),this.completeInternal(t.getData())},s.prototype.onDeferredTaskErrored_=function(t){this.removeCallbacks_(),this.deferredTaskErrored_=!0,this.errorInternal(t.getData(),t.getErrorMessage())},s.prototype.onDeferredTaskInterrupted_=function(){this.interrupt()},s.prototype.removeCallbacks_=function(){this.deferredTask_&&(this.deferredTask_.off(t.enums.Event.COMPLETED,this.onDeferredTaskCompleted_,this),this.deferredTask_.off(t.enums.Event.ERRORED,this.onDeferredTaskErrored_,this),this.deferredTask_.off(t.enums.Event.INTERRUPTED,this.onDeferredTaskInterrupted_,this))},s}(t.Abstract);t.Factory=r}(t||(t={}));var t;!function(t){var r=function(t){function r(e,r){t.call(this,r||"Failsafe for "+e.getName()),this.decoratedTask_=e}return e(r,t),r.prototype.getDecoratedTask=function(){return this.decoratedTask_},r.prototype.interruptImpl=function(){this.decoratedTask_.interrupt()},r.prototype.resetImpl=function(){this.decoratedTask_.reset()},r.prototype.runImpl=function(){this.decoratedTask_.completed(function(){this.completeInternal()}.bind(this)),this.decoratedTask_.errored(function(){this.completeInternal()}.bind(this)),this.decoratedTask_.run()},r}(t.Abstract);t.Failsafe=r}(t||(t={}));var t;!function(t){var r=function(t){function r(e,r,s){t.call(this,s||"Listener"),this.eventTarget_=e,this.eventType_=r}return e(r,t),r.prototype.interruptImpl=function(){this.eventTarget_.removeEventListener(this.eventType_,this.listener_)},r.prototype.resetImpl=function(){},r.prototype.runImpl=function(){var t=this;this.listener_=function(e){t.eventTarget_.removeEventListener(t.eventType_,t.listener_),t.completeInternal(e)},this.eventTarget_.addEventListener(this.eventType_,this.listener_)},r}(t.Abstract);t.Listener=r}(t||(t={}));var t;!function(t){var r=function(r){function s(t,e,s){if(r.call(this,s||"Observer"),this.failUponFirstError_=e,this.observedTasks_=[],t)for(var i in t){var n=t[i];-1==this.observedTasks_.indexOf(n)&&this.observedTasks_.push(n)}}return e(s,r),s.prototype.getObservedTasks=function(){return this.observedTasks_},s.prototype.observe=function(e){return-1==this.observedTasks_.indexOf(e)&&this.observedTasks_.push(e),this.getState()==t.enums.State.RUNNING&&(e.completed(this.onObservedTaskCompleted_,this),e.errored(this.onObservedTaskErrored_,this)),this},s.prototype.stopObserving=function(e){var r=this.observedTasks_.indexOf(e);return r>=0&&(e.off(t.enums.Event.COMPLETED,this.onObservedTaskCompleted_,this),e.off(t.enums.Event.ERRORED,this.onObservedTaskErrored_,this),this.observedTasks_.splice(r,1),this.tryToFinalize_()),this},s.prototype.getCompletedOperationsCount=function(){var t=0;for(var e in this.observedTasks_){var r=this.observedTasks_[e];t+=r.getCompletedOperationsCount()}return t},s.prototype.getOperationsCount=function(){var t=0;for(var e in this.observedTasks_){var r=this.observedTasks_[e];t+=r.getOperationsCount()}return t},s.prototype.runImpl=function(){if(!this.tryToFinalize_())for(var t in this.observedTasks_){var e=this.observedTasks_[t];this.observe(e)}},s.prototype.onObservedTaskCompleted_=function(){this.tryToFinalize_()},s.prototype.onObservedTaskErrored_=function(){this.tryToFinalize_()},s.prototype.tryToFinalize_=function(){if(this.getState()!=t.enums.State.RUNNING)return!1;var e=!0,r=null;for(var s in this.observedTasks_){var i=this.observedTasks_[s];i.getState()==t.enums.State.ERRORED?r=r||i:i.getState()!=t.enums.State.COMPLETED&&(e=!1)}return r&&this.failUponFirstError_?(this.errorInternal(r.getData(),r.getErrorMessage()),!0):r&&e?(this.errorInternal(),!0):e?(this.completeInternal(),!0):!1},s}(t.Abstract);t.Observer=r}(t||(t={}));var t;!function(t){var r=function(r){function s(t,e){if(r.call(this,e||"Promise"),!t)throw Error("Invalid promise provided");if(this.promise_=t,s.isAngularDetected())this.observeForAngular_(t);else if(s.isES6Detected())this.observeForES6_(t);else if(s.isJQueryDetected())this.observeForJQuery_(t);else{if(!s.isQDetected())throw"No supported Promise libraries detected.";this.observeForQ_(t)}}return e(s,r),s.prototype.runImpl=function(){},s.promiseToTask=function(t,e){return new s(t,e)},s.taskToPromise=function(t,e){if(!t)throw Error("Invalid task provided");if(this.isAngularDetected())return this.createAngularPromise_(t,e);if(this.isES6Detected())return this.createES6PromisePromise_(t);if(this.isJQueryDetected())return this.createJQueryPromise_(t);if(this.isQDetected())return this.createQPromise_(t);throw Error("No supported Promise libraries detected.")},s.isAngularDetected=function(){return void 0!==window.angular},s.isES6Detected=function(){return void 0!==window.Promise},s.isJQueryDetected=function(){return void 0!==window.jQuery&&void 0!==window.jQuery.Deferred},s.isQDetected=function(){return void 0!==window.Q&&void 0!==window.Q.defer},s.prototype.completeIfRunning_=function(e){if(this.getState()===t.enums.State.RUNNING)this.completeInternal(e);else{var r=function(){this.completeInternal(e),this.off(r,t.enums.Event.STARTED)}.bind(this);this.started(r)}},s.prototype.errorIfRunning_=function(e,r){if(this.getState()===t.enums.State.RUNNING)this.errorInternal(e,r);else{var s=function(){this.errorInternal(e,r),this.off(s,t.enums.Event.STARTED)}.bind(this);this.started(s)}},s.prototype.observeForAngular_=function(t){var e=this;t.then(function(t){e.completeIfRunning_(t)},function(t){e.errorIfRunning_(t,t)})},s.prototype.observeForES6_=function(t){var e=this;t.then(function(t){e.completeIfRunning_(t)},function(t){e.errorIfRunning_(t,t)})},s.prototype.observeForJQuery_=function(t){var e=this;t.then(function(t){e.completeIfRunning_(t)},function(t){e.errorIfRunning_(t,t)})},s.prototype.observeForQ_=function(t){var e=this;t.then(function(t){e.completeIfRunning_(t)},function(t){e.errorIfRunning_(t,t.message||t)})},s.createAngularPromise_=function(t,e){if(!e)throw Error("Invalid $q provided");var r=e.defer();return t.completed(function(t){r.resolve(t.getData())}),t.errored(function(t){r.reject(t.getErrorMessage())}),r.promise},s.createES6PromisePromise_=function(t){return new window.Promise(function(e,r){t.completed(function(t){e(t.getData())}),t.errored(function(t){r(t.getErrorMessage())})})},s.createJQueryPromise_=function(t){var e=new window.jQuery.Deferred;return t.completed(function(t){e.resolve(t.getData())}),t.errored(function(t){e.reject(t.getErrorMessage())}),e.promise()},s.createQPromise_=function(t){var e=window.Q.defer();return t.completed(function(t){e.resolve(t.getData())}),t.errored(function(t){e.reject(t.getErrorMessage())}),e.promise},s}(t.Abstract);t.Promise=r}(t||(t={}));var t;!function(t){var r=function(r){function s(t,e,s,i){r.call(this,i||"Retry"),this.retries_=0,this.decoratedTask_=t,this.maxRetries_=e||5,this.retryDelay_=s||1e3}return e(s,r),s.prototype.getDecoratedTask=function(){return this.decoratedTask_},s.prototype.getRetries=function(){return this.retries_},s.prototype.interruptImpl=function(){this.stopTimer_(),this.retries_=0,this.removeCallbacks_(),this.decoratedTask_.getState()==t.enums.State.RUNNING&&this.decoratedTask_.interrupt()},s.prototype.resetImpl=function(){this.stopTimer_(),this.retries_=0,this.removeCallbacks_(),this.decoratedTask_.reset()},s.prototype.runImpl=function(){return this.decoratedTask_.completed(this.onDecoratedTaskCompleted_,this),this.decoratedTask_.errored(this.onDecoratedTaskErrored_,this),this.decoratedTask_.getState()==t.enums.State.COMPLETED?void this.onDecoratedTaskCompleted_(this.decoratedTask_):(this.decoratedTask_.getState()==t.enums.State.ERRORED&&this.decoratedTask_.reset(),void this.decoratedTask_.run())},s.prototype.onDecoratedTaskCompleted_=function(t){this.stopTimer_(),this.removeCallbacks_(),this.completeInternal(t.getData())},s.prototype.onDecoratedTaskErrored_=function(t){return this.retries_>=this.maxRetries_?(this.stopTimer_(),this.removeCallbacks_(),void this.errorInternal(t.getData(),t.getErrorMessage())):(this.retries_++,void(this.retryDelay_>=0?this.timeoutId_=setTimeout(this.runImpl.bind(this),this.retryDelay_):this.runImpl()))},s.prototype.removeCallbacks_=function(){this.decoratedTask_.off(t.enums.Event.COMPLETED,this.onDecoratedTaskCompleted_,this),this.decoratedTask_.off(t.enums.Event.ERRORED,this.onDecoratedTaskErrored_,this)},s.prototype.stopTimer_=function(){this.timeoutId_&&(clearTimeout(this.timeoutId_),this.timeoutId_=null)},s.MAX_RETRIES_=5,s.RETRY_DELAY_=5,s}(t.Abstract);t.Retry=r}(t||(t={}));var t;!function(t){var r=function(t){function r(e,r,s){t.call(this,s||"Sleep"),this.timeoutPause_=-1,this.timeoutStart_=-1,this.resetTimerAfterInterruption_=!!r,this.timeout_=e}return e(r,t),r.prototype.resetImpl=function(){this.stopTimer_(),this.timeoutStart_=-1,this.timeoutPause_=-1},r.prototype.interruptImpl=function(){this.stopTimer_(),this.timeoutPause_=(new Date).getTime()},r.prototype.runImpl=function(){if(this.timeoutId_)throw"A timeout for this task already exists.";var t=this.timeout_;!this.resetTimerAfterInterruption_&&this.timeoutStart_>-1&&this.timeoutPause_>-1&&(t+=this.timeoutStart_-this.timeoutPause_),t=Math.max(t,0),this.timeoutId_=setTimeout(this.onTimeout_.bind(this),t),this.timeoutStart_=(new Date).getTime()},r.prototype.stopTimer_=function(){this.timeoutId_&&(clearTimeout(this.timeoutId_),this.timeoutId_=null)},r.prototype.onTimeout_=function(){this.stopTimer_(),this.completeInternal()},r}(t.Abstract);t.Sleep=r}(t||(t={}));var t;!function(t){var r=function(r){function s(t,e){r.call(this,e||"StopOnSuccess"),this.completedTasks_=[],this.erroredTasks_=[],this.taskQueue_=[],this.taskQueueIndex_=0,t&&this.addAll(t)}return e(s,r),s.prototype.addAll=function(t){for(var e=0;e<t.length;e++)this.add(t[e]);return this},s.prototype.add=function(e){if(this.getState()===t.enums.State.RUNNING)throw Error("Cannot add task while running.");var r=this.taskQueue_.indexOf(e);if(r>=0)throw"Cannot add task more than once.";return this.taskQueue_.push(e),this},s.prototype.remove=function(e){if(this.getState()===t.enums.State.RUNNING)throw Error("Cannot remove  task while running.");var r=this.taskQueue_.indexOf(e);if(0>r)throw Error("Attempted to remove an invalid task.");return this.removeCallbacks_(e),this.taskQueue_.splice(this.taskQueue_.indexOf(e),1),this},s.prototype.getCompletedOperationsCount=function(){if(this.getState()===t.enums.State.COMPLETED)return this.getOperationsCount();var e=0;return this.eachTaskInQueue_(function(t){e+=t.getCompletedOperationsCount()}),e},s.prototype.getOperationsCount=function(){var t=0;return this.eachTaskInQueue_(function(e){t+=e.getOperationsCount()}),t},s.prototype.runImpl=function(){if(this.allTasksAreCompleted_())this.completeInternal();else{this.erroredTasks_=[];var t=this.taskQueue_[this.taskQueueIndex_];this.addCallbacks_(t),t.run()}},s.prototype.interruptImpl=function(){this.eachTaskInQueue_(function(e){e.getState()==t.enums.State.RUNNING&&e.interrupt()})},s.prototype.resetImpl=function(){this.taskQueueIndex_=0,this.completedTasks_=[],this.erroredTasks_=[],this.eachTaskInQueue_(function(t){t.reset()})},s.prototype.addCallbacks_=function(t){t.completed(this.childTaskCompleted_,this),t.errored(this.childTaskErrored_,this)},s.prototype.allTasksAreCompleted_=function(){for(var e=0;e<this.taskQueue_.length;e++){var r=this.taskQueue_[e];if(r.getState()!=t.enums.State.COMPLETED)return!1}return!0},s.prototype.checkForTaskCompletion_=function(){if(this.completedTasks_.length>0)this.completeInternal();else{var t=this.completedTasks_.length+this.erroredTasks_.length;t>=this.taskQueue_.length&&(this.erroredTasks_.length>0?this.errorInternal():this.completeInternal())}},s.prototype.childTaskCompleted_=function(t){this.completedTasks_.push(t),this.taskCompletedOrRemoved_(t)},s.prototype.childTaskErrored_=function(t){this.erroredTasks_.push(t),this.taskCompletedOrRemoved_(t)},s.prototype.eachTaskInQueue_=function(t){for(var e=0;e<this.taskQueue_.length;e++){var r=this.taskQueue_[e];t(r)}},s.prototype.removeCallbacks_=function(e){e.off(t.enums.Event.COMPLETED,this.childTaskCompleted_,this),e.off(t.enums.Event.ERRORED,this.childTaskErrored_,this)},s.prototype.taskCompletedOrRemoved_=function(){if(this.taskQueueIndex_++,this.getState()==t.enums.State.RUNNING&&(this.checkForTaskCompletion_(),this.getState()==t.enums.State.RUNNING)){var e=this.taskQueue_[this.taskQueueIndex_];e&&(this.addCallbacks_(e),e.run())}},s}(t.Abstract);t.StopOnSuccess=r
}(t||(t={}));var t;!function(t){var r=function(t){function r(e,r){t.call(this,function(){},e,r||"Stub")}return e(r,t),r}(t.Closure);t.Stub=r}(t||(t={}));var t;!function(t){var r=function(r){function s(t,e,s){r.call(this,s||"Timeout"),this.timeoutPause_=-1,this.timeoutStart_=-1,this.decoratedTask_=t,this.timeout_=e}return e(s,r),s.prototype.getDecoratedTask=function(){return this.decoratedTask_},s.prototype.interruptImpl=function(){this.stopTimer_(),this.removeCallbacks_(),this.decoratedTask_.interrupt(),this.timeoutPause_=(new Date).getTime()},s.prototype.resetImpl=function(){this.stopTimer_(),this.removeCallbacks_(),this.decoratedTask_.reset(),this.timeoutStart_=-1,this.timeoutPause_=-1},s.prototype.runImpl=function(){if(this.timeoutId_)throw"A timeout for this task already exists.";var e=this.timeout_;this.timeoutStart_>-1&&this.timeoutPause_>-1&&(e+=this.timeoutStart_-this.timeoutPause_),e=Math.max(e,0),this.timeoutId_=setTimeout(this.onTimeout_.bind(this),e),this.timeoutStart_=(new Date).getTime(),this.decoratedTask_.getState()==t.enums.State.COMPLETED?this.onDecoratedTaskCompleted_(this.decoratedTask_):this.decoratedTask_.getState()==t.enums.State.ERRORED?this.onDecoratedTaskErrored_(this.decoratedTask_):(this.decoratedTask_.completed(this.onDecoratedTaskCompleted_,this),this.decoratedTask_.errored(this.onDecoratedTaskErrored_,this),this.decoratedTask_.run())},s.prototype.onDecoratedTaskCompleted_=function(t){this.stopTimer_(),this.removeCallbacks_(),this.completeInternal(t.getData())},s.prototype.onDecoratedTaskErrored_=function(t){this.stopTimer_(),this.removeCallbacks_(),this.errorInternal(t.getData(),t.getErrorMessage())},s.prototype.onTimeout_=function(){this.stopTimer_(),this.removeCallbacks_(),this.decoratedTask_.interrupt(),this.errorInternal(this.decoratedTask_.getData(),"Task timed out after "+this.timeout_+"ms")},s.prototype.removeCallbacks_=function(){this.decoratedTask_.off(t.enums.Event.COMPLETED,this.onDecoratedTaskCompleted_,this),this.decoratedTask_.off(t.enums.Event.ERRORED,this.onDecoratedTaskErrored_,this)},s.prototype.stopTimer_=function(){this.timeoutId_&&(clearTimeout(this.timeoutId_),this.timeoutId_=null)},s}(t.Abstract);t.Timeout=r}(t||(t={}));var t;!function(t){var r=function(t){function r(e,r,s,i){if(t.call(this,i||"Tween"),this.elapsed_=0,this.lastUpdateTimestamp_=0,isNaN(r)||0>=r)throw Error("Invalid tween duration provided.");this.callback_=e,this.duration_=r,this.easingFunction_=s||this.linearEase_}return e(r,t),r.prototype.interruptImpl=function(){this.cancelCurrentAnimationFrame_()},r.prototype.resetImpl=function(){this.elapsed_=0,this.lastUpdateTimestamp_=0,this.queueAnimationFrame_(this.updateReset_.bind(this))},r.prototype.runImpl=function(){this.lastUpdateTimestamp_=(new Date).getTime(),this.queueAnimationFrame_(this.updateRunning_.bind(this))},r.prototype.cancelCurrentAnimationFrame_=function(){this.animationFrameId_&&(window.cancelAnimationFrame(this.animationFrameId_),this.animationFrameId_=null)},r.prototype.linearEase_=function(t){return t},r.prototype.queueAnimationFrame_=function(t){this.cancelCurrentAnimationFrame_(),this.animationFrameId_=window.requestAnimationFrame(t)},r.prototype.updateReset_=function(){this.animationFrameId_=null,this.callback_(this.easingFunction_(0))},r.prototype.updateRunning_=function(){var t=(new Date).getTime();this.animationFrameId_=null,this.elapsed_+=t-this.lastUpdateTimestamp_,this.lastUpdateTimestamp_=t;var e=this.easingFunction_(Math.min(1,this.elapsed_/this.duration_));this.callback_(e),this.elapsed_>=this.duration_?this.completeInternal():this.queueAnimationFrame_(this.updateRunning_.bind(this))},r}(t.Abstract);t.Tween=r}(t||(t={}));var t;!function(t){var r=function(r){function s(e,i,n,o){r.call(this,o||"Xhr"),this.postData_=i,this.responseType_=n||s.DEFAULT_RESPONSE_TYPE||t.enums.XhrResponseType.TEXT,this.url_=e}return e(s,r),s.setDefaultResponseType=function(t){this.DEFAULT_RESPONSE_TYPE=t},s.prototype.getResponseType=function(){return this.responseType_},s.prototype.interruptImpl=function(){void 0!==this.xhr_&&(this.xhr_.abort(),this.xhr_=void 0)},s.prototype.resetImpl=function(){this.xhr_=void 0},s.prototype.runImpl=function(){try{var e=void 0===r?"GET":"POST",r=this.createPostDataString_();this.xhr_=new XMLHttpRequest,this.xhr_.addEventListener("load",this.onXhrRequestSuccess_.bind(this)),this.xhr_.addEventListener("abort",this.onXhrRequestErrorOrTimeout_.bind(this)),this.xhr_.addEventListener("error",this.onXhrRequestErrorOrTimeout_.bind(this)),this.xhr_.addEventListener("timeout",this.onXhrRequestErrorOrTimeout_.bind(this)),this.xhr_.open(e,this.url_,!0),this.xhr_.send(r)}catch(s){this.getState()===t.enums.State.RUNNING&&this.errorInternal(s,s.message)}},s.prototype.createPostDataString_=function(){return void 0!==this.postData_?this.serialize(this.postData_):void 0},s.prototype.serialize=function(t,e){var r=[];for(var s in t)if(t.hasOwnProperty(s)){var i=e?e+"["+s+"]":s,n=t[s];r.push("object"==typeof n?this.serialize(n,i):encodeURIComponent(i)+"="+encodeURIComponent(n))}return r.join("&")},s.prototype.onXhrRequestSuccess_=function(){if(this.getState()===t.enums.State.RUNNING)try{var e;switch(this.responseType_){case t.enums.XhrResponseType.JSON:e=JSON.parse(this.xhr_.responseText);break;case t.enums.XhrResponseType.TEXT:e=this.xhr_.responseText;break;case t.enums.XhrResponseType.XML:e=this.xhr_.responseXML}this.completeInternal(e)}catch(r){this.errorInternal(r,"Invalid response")}},s.prototype.onXhrRequestErrorOrTimeout_=function(){this.getState()===t.enums.State.RUNNING&&this.errorInternal(this.xhr_.status,this.xhr_.statusText)},s}(t.Abstract);t.Xhr=r}(t||(t={}));var t;!function(t){var e;!function(t){!function(t){t[t.STARTED="STARTED"]="STARTED",t[t.INTERRUPTED="INTERRUPTED"]="INTERRUPTED",t[t.COMPLETED="COMPLETED"]="COMPLETED",t[t.ERRORED="ERRORED"]="ERRORED",t[t.FINAL="FINAL"]="FINAL"}(t.Event||(t.Event={}));t.Event}(e=t.enums||(t.enums={}))}(t||(t={}));var t;!function(t){var e;!function(t){!function(t){t[t.INITIALIZED="INITIALIZED"]="INITIALIZED",t[t.RUNNING="RUNNING"]="RUNNING",t[t.INTERRUPTED="INTERRUPTED"]="INTERRUPTED",t[t.COMPLETED="COMPLETED"]="COMPLETED",t[t.ERRORED="ERRORED"]="ERRORED"}(t.State||(t.State={}));t.State}(e=t.enums||(t.enums={}))}(t||(t={}));var t;return function(t){var e;!function(t){!function(t){t[t.JSON="JSON"]="JSON",t[t.TEXT="TEXT"]="TEXT",t[t.XML="XML"]="XML"}(t.XhrResponseType||(t.XhrResponseType={}));t.XhrResponseType}(e=t.enums||(t.enums={}))}(t||(t={})),t});
//# sourceMappingURL=task-runner.min.js.map