(function(root, factory) {
  if (typeof define === 'function' && define.amd) {
    define([], factory);
  } else if (typeof exports === 'object') {
    module.exports = factory();
  } else {
    root.tr = factory();
  }
}(this, function() {
var tr;(function(t){var e=function(){function e(r){if(this.name_=r,this.state_=t.enums.State.INITIALIZED,this.taskCallbackMap_={},this.uniqueID_=e.UNIQUE_ID_COUNTER++,window.DEBUG){var s=Error("Constructor");if(s.hasOwnProperty("stack")){var n=s.stack;this.creationContext_=n.replace(/^\s+at\s+/gm,"").replace(/\s$/gm,"").split("\n").slice(2)}this.logger_=console.log}else this.logger_=function(){}}return e.prototype.log=function(t){this.logger_.call(console,t+" :: "+this)},e.prototype.toString=function(){return this.name_+" [id: "+this.uniqueID_+"]"},e.prototype.getCompletedOperationsCount=function(){return this.state_===t.enums.State.COMPLETED?1:0},e.prototype.getCreationContext=function(){return this.creationContext_},e.prototype.getData=function(){return this.data_},e.prototype.getErrorMessage=function(){return this.errorMessage_},e.prototype.getName=function(){return this.name_},e.prototype.getOperationsCount=function(){return 1},e.prototype.getState=function(){return this.state_},e.prototype.getUniqueID=function(){return this.uniqueID_},e.prototype.completed=function(e,r){return this.on(t.enums.Event.COMPLETED,e,r)},e.prototype.errored=function(e,r){return this.on(t.enums.Event.ERRORED,e,r)},e.prototype.final=function(e,r){return this.on(t.enums.Event.FINAL,e,r)},e.prototype.interrupt=function(){if(this.state_!=t.enums.State.RUNNING)throw Error("Cannot interrupt a task that is not running.");return this.log("Interrupting"),this.state_=t.enums.State.INTERRUPTED,this.interruptImpl(),this.executeCallbacks(t.enums.Event.INTERRUPTED),this},e.prototype.interrupted=function(e,r){return this.on(t.enums.Event.INTERRUPTED,e,r)},e.prototype.interruptFor=function(e){this.log("Interrupting for "+e),this.interruptingTask_=e,this.interrupt();var r=this;return e.completed(function(t){t==r.interruptingTask_&&(r.interruptingTask_=null,r.run())},this),e.errored(function(e){e==r.interruptingTask_&&(r.interruptingTask_=null,r.state_=t.enums.State.RUNNING,r.errorInternal(e.getData(),e.getErrorMessage()))},this),this},e.prototype.off=function(t,e,r){this.taskCallbackMap_[t]=this.taskCallbackMap_[t]||[];for(var s=this.taskCallbackMap_[t],n=0,i=s.length;i>n;n++){var o=s[n];if(o.matches(e,r))return s.splice(n,1),this}return this},e.prototype.on=function(t,e,s){this.taskCallbackMap_[t]=this.taskCallbackMap_[t]||[];for(var n=this.taskCallbackMap_[t],i=0,o=n.length;o>i;i++){var a=n[i];if(a.matches(e,s))return this}return n.push(new r(e,s)),this},e.prototype.reset=function(){if(this.state_==t.enums.State.RUNNING)throw Error("Cannot reset a running task.");return this.log("Resetting"),this.state_!=t.enums.State.INITIALIZED&&(this.data_=void 0,this.errorMessage_=void 0,this.state_=t.enums.State.INITIALIZED,this.resetImpl()),this},e.prototype.run=function(){if(this.state_==t.enums.State.RUNNING)throw Error("Cannot run a running task.");return this.log("Running"),this.state_!=t.enums.State.COMPLETED&&(this.interruptingTask_=null,this.data_=void 0,this.errorMessage_=void 0,this.state_=t.enums.State.RUNNING,this.executeCallbacks(t.enums.Event.STARTED),this.runImpl()),this},e.prototype.started=function(e,r){return this.on(t.enums.Event.STARTED,e,r)},e.prototype.completeInternal=function(e){if(this.state_!==t.enums.State.RUNNING)throw"Cannot complete an inactive task.";this.log("Internal complete"),this.data_=e,this.state_=t.enums.State.COMPLETED,this.executeCallbacks(t.enums.Event.COMPLETED),this.executeCallbacks(t.enums.Event.FINAL)},e.prototype.errorInternal=function(e,r){if(this.state_!=t.enums.State.RUNNING)throw"Cannot error an inactive task.";this.log("Internal error"),this.data_=e,this.errorMessage_=r,this.state_=t.enums.State.ERRORED,this.executeCallbacks(t.enums.Event.ERRORED),this.executeCallbacks(t.enums.Event.FINAL)},e.prototype.executeCallbacks=function(t){var e=this.taskCallbackMap_[t];if(e)for(var r=0,s=e.length;s>r;r++)e[r].execute(this)},e.prototype.interruptImpl=function(){},e.prototype.resetImpl=function(){},e.prototype.runImpl=function(){throw Error("Required methods runImpl() not implemented.")},e.UNIQUE_ID_COUNTER=0,e}();t.Abstract=e;var r=function(){function t(t,e){this.callback_=t,this.scope_=e}return t.prototype.execute=function(t){this.scope_?this.callback_.call(this.scope_,t):this.callback_(t)},t.prototype.matches=function(t,e){return this.callback_===t&&this.scope_===e},t}()})(tr||(tr={}));var __extends=this.__extends||function(t,e){function r(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);r.prototype=e.prototype,t.prototype=new r},tr;(function(t){var e=function(e){function r(r,s,n){e.call(this,n||"Chain"),this.mostRecentTaskArgs_=[],this.graph_=new t.Graph,this.graph_.completed(this.completeInternal.bind(this)),this.graph_.errored(this.errorInternal.bind(this)),void 0!==r&&this.completed(r),void 0!==s&&this.errored(s)}return __extends(r,e),r.prototype.else=function(){for(var t=[],e=0;arguments.length>e;e++)t[e-0]=arguments[e];return this.or.apply(this,t)},r.prototype.first=function(){for(var t=[],e=0;arguments.length>e;e++)t[e-0]=arguments[e];if(this.graph_.getOperationsCount()>0)throw Error("Cannot call first after tasks have been added");return this.then.apply(this,t),this},r.prototype.getDecoratedTask=function(){return this.graph_},r.prototype.or=function(){for(var e=[],r=0;arguments.length>r;r++)e[r-0]=arguments[r];this.graph_.removeAll(this.mostRecentTaskArgs_);var s=new t.StopOnSuccess;return s.add(new t.Composite(!0,this.mostRecentTaskArgs_)),e.length>1?s.add(new t.Composite(!0,e)):s.add(e[0]),this.graph_.addToEnd(s),this.mostRecentTaskArgs_=[s],this},r.prototype.otherwise=function(){for(var t=[],e=0;arguments.length>e;e++)t[e-0]=arguments[e];return this.or.apply(this,t)},r.prototype.then=function(){for(var t=[],e=0;arguments.length>e;e++)t[e-0]=arguments[e];return this.mostRecentTaskArgs_=t,this.graph_.addAllToEnd(t),this},r.prototype.getOperationsCount=function(){return this.graph_.getOperationsCount()},r.prototype.getCompletedOperationsCount=function(){return this.graph_.getCompletedOperationsCount()},r.prototype.runImpl=function(){this.graph_.run()},r.prototype.interruptImpl=function(){this.graph_.interrupt()},r.prototype.resetImpl=function(){this.graph_.reset()},r}(t.Abstract);t.Chain=e})(tr||(tr={}));var tr;(function(t){var e=function(e){function r(t,r,s){e.call(this,s||"Closure"),this.runImplFn_=t,this.autoCompleteUponRun_=!!r}return __extends(r,e),r.prototype.runImpl=function(){try{this.runImplFn_(this),this.autoCompleteUponRun_&&this.getState()===t.enums.State.RUNNING&&this.completeInternal()}catch(e){this.getState()===t.enums.State.RUNNING&&this.errorInternal(e,e.message)}},r.prototype.complete=function(t){this.completeInternal(t)},r.prototype.error=function(t,e){this.errorInternal(t,e)},r}(t.Abstract);t.Closure=e})(tr||(tr={}));var tr;(function(t){var e=function(e){function r(t,r,s){e.call(this,s||"Composite"),this.completedTasks_=[],this.erroredTasks_=[],this.taskQueue_=[],this.taskQueueIndex_=0,this.parallel_=t,r&&this.addAll(r)}return __extends(r,e),r.prototype.add=function(e){var r=this.taskQueue_.indexOf(e);if(r>=0)throw Error("Cannot add task more than once.");return this.taskQueue_.push(e),this.getState()==t.enums.State.RUNNING&&(r=this.taskQueue_.indexOf(e),(this.parallel_||this.taskQueueIndex_==r)&&(this.addCallbacks_(e),e.run())),this},r.prototype.addAll=function(t){for(var e=0;t.length>e;e++)this.add(t[e]);return this},r.prototype.remove=function(e){var r=this.taskQueue_.indexOf(e);if(0>r)throw Error("Attempted to remove an invalid task.");return this.removeCallbacks_(e),this.taskQueue_.splice(this.taskQueue_.indexOf(e),1),this.getState()==t.enums.State.RUNNING&&((this.parallel_||this.taskQueueIndex_>=r)&&this.taskQueueIndex_--,(e.getState()==t.enums.State.RUNNING||e.getState()==t.enums.State.INTERRUPTED)&&this.taskCompletedOrRemoved_(e)),this},r.prototype.getCompletedOperationsCount=function(){var t=0;return this.eachTaskInQueue_(function(e){t+=e.getCompletedOperationsCount()}),t},r.prototype.getOperationsCount=function(){var t=0;return this.eachTaskInQueue_(function(e){t+=e.getOperationsCount()}),t},r.prototype.interruptImpl=function(){this.eachTaskInQueue_(function(e){e.getState()==t.enums.State.RUNNING&&e.interrupt()})},r.prototype.resetImpl=function(){this.taskQueueIndex_=0,this.completedTasks_=[],this.erroredTasks_=[],this.eachTaskInQueue_(function(t){t.reset()})},r.prototype.runImpl=function(){if(this.allTasksAreCompleted_())this.completeInternal();else if(this.erroredTasks_=[],this.parallel_)this.eachTaskInQueue_(function(e){this.getState()===t.enums.State.RUNNING&&(this.addCallbacks_(e),e.run())}.bind(this));else{var e=this.taskQueue_[this.taskQueueIndex_];this.addCallbacks_(e),e.run()}},r.prototype.addCallbacks_=function(t){t.completed(this.childTaskCompleted_,this),t.errored(this.childTaskErrored_,this)},r.prototype.allTasksAreCompleted_=function(){for(var e=0;this.taskQueue_.length>e;e++){var r=this.taskQueue_[e];if(r.getState()!=t.enums.State.COMPLETED)return!1}return!0},r.prototype.checkForTaskCompletion_=function(){if(!this.flushQueueInProgress_){var t=this.completedTasks_.length+this.erroredTasks_.length;t>=this.taskQueue_.length&&(this.erroredTasks_.length>0?this.errorInternal():this.completeInternal())}},r.prototype.childTaskCompleted_=function(t){this.completedTasks_.push(t),this.taskCompletedOrRemoved_(t)},r.prototype.childTaskErrored_=function(t){this.erroredTasks_.push(t),this.parallel_?this.checkForTaskCompletion_():this.errorInternal(t.getData(),t.getErrorMessage())},r.prototype.eachTaskInQueue_=function(t){for(var e=0;this.taskQueue_.length>e;e++){var r=this.taskQueue_[e];t(r)}},r.prototype.flushQueue=function(e){for(this.flushQueueInProgress_=!!e,this.eachTaskInQueue_(function(e){e.getState()==t.enums.State.RUNNING&&e.interrupt()});this.taskQueue_.length>0;){var r=this.taskQueue_[this.taskQueue_.length-1];this.remove(r)}this.completedTasks_=[],this.erroredTasks_=[],this.flushQueueInProgress_=!1},r.prototype.removeCallbacks_=function(e){e.off(t.enums.Event.COMPLETED,this.childTaskCompleted_,this),e.off(t.enums.Event.ERRORED,this.childTaskErrored_,this)},r.prototype.taskCompletedOrRemoved_=function(){if(this.taskQueueIndex_++,this.getState()==t.enums.State.RUNNING&&(this.checkForTaskCompletion_(),!this.parallel_&&this.getState()==t.enums.State.RUNNING)){var e=this.taskQueue_[this.taskQueueIndex_];e&&(this.addCallbacks_(e),e.run())}},r}(t.Abstract);t.Composite=e})(tr||(tr={}));var tr;(function(t){var e=function(t){function e(e,r){if(t.call(this,r||"Decorator"),this.decorated_=e,!this.isFunction_("run"))throw Error("Required method run() not implemented.")}return __extends(e,t),e.prototype.getDecorated=function(){return this.decorated_},e.prototype.runImpl=function(){this.decorated_.run(this.complete_.bind(this),this.error_.bind(this))},e.prototype.interruptImpl=function(){this.isFunction_("interrupt")&&this.decorated_.interrupt()},e.prototype.resetImpl=function(){this.isFunction_("reset")&&this.decorated_.reset()},e.prototype.complete_=function(t){this.completeInternal(t)},e.prototype.error_=function(t,e){this.errorInternal(t,e)},e.prototype.isFunction_=function(t){return this.decorated_.hasOwnProperty(t)&&"function"==typeof this.decorated_[t]},e}(t.Abstract);t.Decorator=e})(tr||(tr={}));var tr;(function(t){var e=function(e){function r(t,r,s,n){e.call(this,n||"Factory"),this.recreateDeferredTaskAfterError_=!1,this.deferredTaskErrored_=!1,this.argsArray_=s,this.taskFactoryFn_=t,this.thisArg_=this}return __extends(r,e),r.prototype.getDecoratedTask=function(){return this.deferredTask_},r.prototype.recreateDeferredTaskAfterError=function(t){this.recreateDeferredTaskAfterError_=t},r.prototype.resetImpl=function(){this.removeCallbacks_(),this.deferredTask_&&(this.deferredTask_=null)},r.prototype.interruptImpl=function(){this.deferredTask_&&(this.removeCallbacks_(),this.deferredTask_.interrupt())},r.prototype.runImpl=function(){(!this.deferredTask_||this.recreateDeferredTaskAfterError_&&this.deferredTaskErrored_)&&(this.deferredTask_=this.thisArg_?this.taskFactoryFn_.apply(this.thisArg_,this.argsArray_||[]):this.taskFactoryFn_()),this.deferredTask_.getState()==t.enums.State.COMPLETED?this.onDeferredTaskCompleted_(this.deferredTask_):this.deferredTask_.getState()==t.enums.State.ERRORED?this.onDeferredTaskErrored_(this.deferredTask_):(this.deferredTask_.completed(this.onDeferredTaskCompleted_,this),this.deferredTask_.errored(this.onDeferredTaskErrored_,this),this.deferredTask_.interrupted(this.onDeferredTaskInterrupted_,this),this.deferredTask_.run())},r.prototype.onDeferredTaskCompleted_=function(t){this.removeCallbacks_(),this.completeInternal(t.getData())},r.prototype.onDeferredTaskErrored_=function(t){this.removeCallbacks_(),this.deferredTaskErrored_=!0,this.errorInternal(t.getData(),t.getErrorMessage())},r.prototype.onDeferredTaskInterrupted_=function(){this.interrupt()},r.prototype.removeCallbacks_=function(){this.deferredTask_&&(this.deferredTask_.off(t.enums.Event.COMPLETED,this.onDeferredTaskCompleted_,this),this.deferredTask_.off(t.enums.Event.ERRORED,this.onDeferredTaskErrored_,this),this.deferredTask_.off(t.enums.Event.INTERRUPTED,this.onDeferredTaskInterrupted_,this))},r}(t.Abstract);t.Factory=e})(tr||(tr={}));var tr;(function(t){var e=function(t){function e(e,r){t.call(this,r||"Failsafe for "+e.getName()),this.decoratedTask_=e}return __extends(e,t),e.prototype.getDecoratedTask=function(){return this.decoratedTask_},e.prototype.interruptImpl=function(){this.decoratedTask_.interrupt()},e.prototype.resetImpl=function(){this.decoratedTask_.reset()},e.prototype.runImpl=function(){this.decoratedTask_.completed(function(){this.completeInternal()}.bind(this)),this.decoratedTask_.errored(function(){this.completeInternal()}.bind(this)),this.decoratedTask_.run()},e}(t.Abstract);t.Failsafe=e})(tr||(tr={}));var tr;(function(t){var e=function(e){function r(t){e.call(this,t||"Graph"),this.erroredTasks_=[],this.taskIdToDependenciesMap_={},this.tasks_=[]}return __extends(r,e),r.prototype.add=function(t,e){return this.addAll([t],e)},r.prototype.addAll=function(e,r){for(var s=0,n=e.length;n>s;s++){var i=e[s];if(this.tasks_.indexOf(i)>=0)throw Error("Cannot add task more than once.");this.tasks_.push(i),this.updateBlockers_([i],r),this.validateDependencies_(i)}return this.getState()==t.enums.State.RUNNING&&this.runAllReadyTasks_(),this},r.prototype.addToEnd=function(t){return this.add(t,this.tasks_.slice(0))},r.prototype.addAllToEnd=function(t){return this.addAll(t,this.tasks_.slice(0))},r.prototype.addBlockersTo=function(t,e){return this.updateBlockers_(e,t),this},r.prototype.remove=function(t){return this.removeAll([t])},r.prototype.removeAll=function(e){this.verifyInGraph_(e,"Cannot remove tasks not in graph.");for(var r=0,s=e.length;s>r;r++){var n=e[r];this.removeCallbacksFrom_(n),this.tasks_.splice(this.tasks_.indexOf(n),1),delete this.taskIdToDependenciesMap_[n.getUniqueID()]}for(var r=0,s=this.tasks_.length;s>r;r++)this.validateDependencies_(this.tasks_[r]);return this.getState()==t.enums.State.RUNNING&&this.completeOrRunNext_(),this},r.prototype.removeBlockersFrom=function(e,r){this.verifyInGraph_(e,"Cannot remove blockers not in graph."),this.verifyInGraph_(r,"Cannot remove tasks not in graph.");for(var s=this.taskIdToDependenciesMap_,n=0,i=r.length;i>n;n++){for(var o=r[n],a=s[o.getUniqueID()]||[],n=0,i=e.length;i>n;n++){var u=e[n],h=a.indexOf(u);h>=0&&a.splice(h,1)}s[o.getUniqueID()]=a}return this.getState()===t.enums.State.RUNNING&&this.completeOrRunNext_(),this},r.prototype.getOperationsCount=function(){var t=0;for(var e in this.tasks_)t+=this.tasks_[e].getOperationsCount();return t},r.prototype.getCompletedOperationsCount=function(){var t=0;for(var e in this.tasks_)t+=this.tasks_[e].getCompletedOperationsCount();return t},r.prototype.runImpl=function(){this.erroredTasks_=[],this.beforeFirstRunInvoked_||(this.beforeFirstRun(),this.beforeFirstRunInvoked_=!0),this.completeOrRunNext_()},r.prototype.interruptImpl=function(){for(var e in this.tasks_){var r=this.tasks_[e];r.getState()==t.enums.State.RUNNING&&(this.removeCallbacksFrom_(r),r.interrupt())}},r.prototype.resetImpl=function(){this.erroredTasks_=[];for(var t in this.tasks_)this.tasks_[t].reset()},r.prototype.beforeFirstRun=function(){},r.prototype.addCallbacksTo_=function(t){t.completed(this.childTaskCompleted_,this),t.errored(this.childTaskErrored_,this)},r.prototype.areAllTasksCompleted_=function(){for(var e in this.tasks_)if(this.tasks_[e].getState()!=t.enums.State.COMPLETED)return!1;return!0},r.prototype.childTaskCompleted_=function(t){this.removeCallbacksFrom_(t),this.completeOrRunNext_()},r.prototype.childTaskErrored_=function(t){this.removeCallbacksFrom_(t),this.erroredTasks_.push(t),this.completeOrRunNext_()},r.prototype.completeOrRunNext_=function(){if(this.getState()===t.enums.State.RUNNING)if(this.areAllTasksCompleted_())this.completeInternal();else if(0==this.erroredTasks_.length)this.runAllReadyTasks_();else{for(var e in this.tasks_){var r=this.tasks_[e];r.getState()===t.enums.State.RUNNING&&r.interrupt()}this.errorInternal()}},r.prototype.hasIncompleteBlockers_=function(e){var r=this.taskIdToDependenciesMap_[e.getUniqueID()];if(r)for(var s in r){var n=r[s];if(n.getState()!=t.enums.State.COMPLETED)return!0}return!1},r.prototype.isAnyTaskRunning_=function(){for(var e in this.tasks_)if(this.tasks_[e].getState()==t.enums.State.RUNNING)return!0;return!1},r.prototype.removeCallbacksFrom_=function(e){e.off(t.enums.Event.COMPLETED,this.childTaskCompleted_,this),e.off(t.enums.Event.ERRORED,this.childTaskErrored_,this)},r.prototype.runAllReadyTasks_=function(){for(var e in this.tasks_){var r=this.tasks_[e];if(this.getState()!==t.enums.State.RUNNING)return;this.erroredTasks_.indexOf(r)>=0||this.hasIncompleteBlockers_(r)||r.getState()!=t.enums.State.RUNNING&&r.getState()!=t.enums.State.COMPLETED&&(this.addCallbacksTo_(r),r.run())}},r.prototype.updateBlockers_=function(e,r){if(r&&0!==r.length){this.verifyInGraph_(e,"Cannot add blockers to tasks not in graph."),this.verifyInGraph_(r,"Cannot block on tasks not in graph.");for(var s=0,n=e.length;n>s;s++){var i=e[s];if(i.getState()!==t.enums.State.INITIALIZED)throw Error("Cannot add blocking dependency to running task.");for(var o=this.taskIdToDependenciesMap_[i.getUniqueID()]||[],s=0,n=r.length;n>s;s++){var a=r[s];0>o.indexOf(a)&&o.push(a)}this.taskIdToDependenciesMap_[i.getUniqueID()]=o}}},r.prototype.validateDependencies_=function(t){var e=this.taskIdToDependenciesMap_[t.getUniqueID()];if(e){if(e.indexOf(t)>=0)throw Error("Cyclic dependency detected.");this.verifyInGraph_(e,"Task depends on blocker that is not in the graph")}},r.prototype.verifyInGraph_=function(t,e){for(var r=0,s=t.length;s>r;r++)if(0>this.tasks_.indexOf(t[r]))throw Error(e)},r}(t.Abstract);t.Graph=e})(tr||(tr={}));var tr;(function(t){var e=function(t){function e(e,r,s){t.call(this,s||"Listener"),this.eventTarget_=e,this.eventType_=r}return __extends(e,t),e.prototype.interruptImpl=function(){this.eventTarget_.removeEventListener(this.eventType_,this.listener_)},e.prototype.resetImpl=function(){},e.prototype.runImpl=function(){var t=this;this.listener_=function(e){t.eventTarget_.removeEventListener(t.eventType_,t.listener_),t.completeInternal(e)},this.eventTarget_.addEventListener(this.eventType_,this.listener_)},e}(t.Abstract);t.Listener=e})(tr||(tr={}));var tr;(function(t){var e=function(e){function r(t,r,s){if(e.call(this,s||"Observer"),this.failUponFirstError_=r,this.observedTasks_=[],t)for(var n in t){var i=t[n];-1==this.observedTasks_.indexOf(i)&&this.observedTasks_.push(i)}}return __extends(r,e),r.prototype.getObservedTasks=function(){return this.observedTasks_},r.prototype.observe=function(e){return-1==this.observedTasks_.indexOf(e)&&this.observedTasks_.push(e),this.getState()==t.enums.State.RUNNING&&(e.completed(this.onObservedTaskCompleted_,this),e.errored(this.onObservedTaskErrored_,this)),this},r.prototype.stopObserving=function(e){var r=this.observedTasks_.indexOf(e);return r>=0&&(e.off(t.enums.Event.COMPLETED,this.onObservedTaskCompleted_,this),e.off(t.enums.Event.ERRORED,this.onObservedTaskErrored_,this),this.observedTasks_.splice(r,1),this.tryToFinalize_()),this},r.prototype.getCompletedOperationsCount=function(){var t=0;for(var e in this.observedTasks_){var r=this.observedTasks_[e];t+=r.getCompletedOperationsCount()}return t},r.prototype.getOperationsCount=function(){var t=0;for(var e in this.observedTasks_){var r=this.observedTasks_[e];t+=r.getOperationsCount()}return t},r.prototype.runImpl=function(){if(!this.tryToFinalize_())for(var t in this.observedTasks_){var e=this.observedTasks_[t];this.observe(e)}},r.prototype.onObservedTaskCompleted_=function(){this.tryToFinalize_()},r.prototype.onObservedTaskErrored_=function(){this.tryToFinalize_()},r.prototype.tryToFinalize_=function(){if(this.getState()!=t.enums.State.RUNNING)return!1;var e=!0,r=null;for(var s in this.observedTasks_){var n=this.observedTasks_[s];n.getState()==t.enums.State.ERRORED?r=r||n:n.getState()!=t.enums.State.COMPLETED&&(e=!1)}return r&&this.failUponFirstError_?(this.errorInternal(r.getData(),r.getErrorMessage()),!0):r&&e?(this.errorInternal(),!0):e?(this.completeInternal(),!0):!1},r}(t.Abstract);t.Observer=e})(tr||(tr={}));var tr;(function(t){var e=function(e){function r(t,s){if(e.call(this,s||"Promise"),!t)throw Error("Invalid promise provided");if(this.promise_=t,r.isAngularDetected())this.observeForAngular_(t);else if(r.isES6Detected())this.observeForES6_(t);else if(r.isJQueryDetected())this.observeForJQuery_(t);else{if(!r.isQDetected())throw"No supported Promise libraries detected.";this.observeForQ_(t)}}return __extends(r,e),r.prototype.runImpl=function(){},r.promiseToTask=function(t,e){return new r(t,e)},r.taskToPromise=function(t,e){if(!t)throw Error("Invalid task provided");if(this.isAngularDetected())return this.createAngularPromise_(t,e);if(this.isES6Detected())return this.createES6PromisePromise_(t);if(this.isJQueryDetected())return this.createJQueryPromise_(t);if(this.isQDetected())return this.createQPromise_(t);throw Error("No supported Promise libraries detected.")},r.isAngularDetected=function(){return void 0!==window.angular},r.isES6Detected=function(){return void 0!==window.Promise},r.isJQueryDetected=function(){return void 0!==window.jQuery&&void 0!==window.jQuery.Deferred},r.isQDetected=function(){return void 0!==window.Q&&void 0!==window.Q.defer},r.prototype.completeIfRunning_=function(e){if(this.getState()===t.enums.State.RUNNING)this.completeInternal(e);else{var r=function(){this.completeInternal(e),this.off(r,t.enums.Event.STARTED)}.bind(this);this.started(r)}},r.prototype.errorIfRunning_=function(e,r){if(this.getState()===t.enums.State.RUNNING)this.errorInternal(e,r);else{var s=function(){this.errorInternal(e,r),this.off(s,t.enums.Event.STARTED)}.bind(this);this.started(s)}},r.prototype.observeForAngular_=function(t){var e=this;t.then(function(t){e.completeIfRunning_(t)},function(t){e.errorIfRunning_(t,t)})},r.prototype.observeForES6_=function(t){var e=this;t.then(function(t){e.completeIfRunning_(t)},function(t){e.errorIfRunning_(t,t)})},r.prototype.observeForJQuery_=function(t){var e=this;t.then(function(t){e.completeIfRunning_(t)},function(t){e.errorIfRunning_(t,t)})},r.prototype.observeForQ_=function(t){var e=this;t.then(function(t){e.completeIfRunning_(t)},function(t){e.errorIfRunning_(t,t.message||t)})},r.createAngularPromise_=function(t,e){if(!e)throw Error("Invalid $q provided");var r=e.defer();return t.completed(function(t){r.resolve(t.getData())}),t.errored(function(t){r.reject(t.getErrorMessage())}),r.promise},r.createES6PromisePromise_=function(t){return new window.Promise(function(e,r){t.completed(function(t){e(t.getData())}),t.errored(function(t){r(t.getErrorMessage())})})},r.createJQueryPromise_=function(t){var e=new window.jQuery.Deferred;return t.completed(function(t){e.resolve(t.getData())}),t.errored(function(t){e.reject(t.getErrorMessage())}),e.promise()},r.createQPromise_=function(t){var e=window.Q.defer();return t.completed(function(t){e.resolve(t.getData())}),t.errored(function(t){e.reject(t.getErrorMessage())}),e.promise},r}(t.Abstract);t.Promise=e})(tr||(tr={}));var tr;(function(t){var e=function(e){function r(t,r){e.call(this,r||"Resolver"),this.blockerIdsToFailsafeWrappersMap_={},this.blockers_=[],this.prioritizedResolutions_=[],this.taskIdToBlockingTasksMap_={},this.runFirstAvailableResolution_=!!t}return __extends(r,e),r.prototype.getChosenResolution=function(){return this.resolution_},r.prototype.addResolution=function(e,r){r=r||[],this.prioritizedResolutions_.push(e),this.taskIdToBlockingTasksMap_[e.getUniqueID()]=r;for(var s=0,n=r.length;n>s;s++){var i=r[s];if(!(this.blockers_.indexOf(i)>=0)){this.runFirstAvailableResolution_&&i.completed(this.checkForEarlyResolution_,this);var o=new t.Failsafe(i);this.blockerIdsToFailsafeWrappersMap_[i.getUniqueID()]=o,this.blockers_.push(i),this.add(o)}}return this},r.prototype.allBlockersFinalized_=function(){this.chooseResolution_(),this.resolution_?this.addToEnd(this.resolution_):this.errorInternal("No valid resolutions found.")},r.prototype.beforeFirstRun=function(){this.final_=new t.Closure(this.allBlockersFinalized_.bind(this),!0,"Closure - state-chooser"),this.addToEnd(this.final_)},r.prototype.checkForEarlyResolution_=function(){if(this.chooseResolution_(),this.resolution_){var e=new t.Stub;this.add(e),this.remove(this.final_);for(var r=0,s=this.blockers_.length;s>r;r++){var n=this.blockers_[r];n.getState()===t.enums.State.RUNNING&&(n.off(t.enums.Event.COMPLETED,this.checkForEarlyResolution_,this),n.interrupt());var i=this.blockerIdsToFailsafeWrappersMap_[n.getUniqueID()];this.remove(i)}this.add(this.resolution_),this.remove(e)}},r.prototype.chooseResolution_=function(){for(var e=0;this.prioritizedResolutions_.length>e;e++){for(var r=this.prioritizedResolutions_[e],s=this.taskIdToBlockingTasksMap_[r.getUniqueID()],n=!0,i=0;s.length>i;i++){var o=s[i];if(o.getState()===t.enums.State.ERRORED){n=!1;break}}if(n)return this.resolution_=r,void 0}},r}(t.Graph);t.Resolver=e})(tr||(tr={}));var tr;(function(t){var e=function(e){function r(t,r,s,n){e.call(this,n||"Retry"),this.retries_=0,this.decoratedTask_=t,this.maxRetries_=r||5,this.retryDelay_=s||1e3}return __extends(r,e),r.prototype.getDecoratedTask=function(){return this.decoratedTask_},r.prototype.getRetries=function(){return this.retries_},r.prototype.interruptImpl=function(){this.stopTimer_(),this.retries_=0,this.removeCallbacks_(),this.decoratedTask_.getState()==t.enums.State.RUNNING&&this.decoratedTask_.interrupt()},r.prototype.resetImpl=function(){this.stopTimer_(),this.retries_=0,this.removeCallbacks_(),this.decoratedTask_.reset()},r.prototype.runImpl=function(){return this.decoratedTask_.completed(this.onDecoratedTaskCompleted_,this),this.decoratedTask_.errored(this.onDecoratedTaskErrored_,this),this.decoratedTask_.getState()==t.enums.State.COMPLETED?(this.onDecoratedTaskCompleted_(this.decoratedTask_),void 0):(this.decoratedTask_.getState()==t.enums.State.ERRORED&&this.decoratedTask_.reset(),this.decoratedTask_.run(),void 0)},r.prototype.onDecoratedTaskCompleted_=function(t){this.stopTimer_(),this.removeCallbacks_(),this.completeInternal(t.getData())},r.prototype.onDecoratedTaskErrored_=function(t){return this.retries_>=this.maxRetries_?(this.stopTimer_(),this.removeCallbacks_(),this.errorInternal(t.getData(),t.getErrorMessage()),void 0):(this.retries_++,this.retryDelay_>=0?this.timeoutId_=setTimeout(this.runImpl.bind(this),this.retryDelay_):this.runImpl(),void 0)},r.prototype.removeCallbacks_=function(){this.decoratedTask_.off(t.enums.Event.COMPLETED,this.onDecoratedTaskCompleted_,this),this.decoratedTask_.off(t.enums.Event.ERRORED,this.onDecoratedTaskErrored_,this)},r.prototype.stopTimer_=function(){this.timeoutId_&&(clearTimeout(this.timeoutId_),this.timeoutId_=null)},r.MAX_RETRIES_=5,r.RETRY_DELAY_=5,r}(t.Abstract);t.Retry=e})(tr||(tr={}));var tr;(function(t){var e=function(t){function e(e,r,s){t.call(this,s||"Sleep"),this.timeoutPause_=-1,this.timeoutStart_=-1,this.resetTimerAfterInterruption_=!!r,this.timeout_=e}return __extends(e,t),e.prototype.resetImpl=function(){this.stopTimer_(),this.timeoutStart_=-1,this.timeoutPause_=-1},e.prototype.interruptImpl=function(){this.stopTimer_(),this.timeoutPause_=(new Date).getTime()},e.prototype.runImpl=function(){if(this.timeoutId_)throw"A timeout for this task already exists.";var t=this.timeout_;!this.resetTimerAfterInterruption_&&this.timeoutStart_>-1&&this.timeoutPause_>-1&&(t+=this.timeoutStart_-this.timeoutPause_),t=Math.max(t,0),this.timeoutId_=setTimeout(this.onTimeout_.bind(this),t),this.timeoutStart_=(new Date).getTime()},e.prototype.stopTimer_=function(){this.timeoutId_&&(clearTimeout(this.timeoutId_),this.timeoutId_=null)},e.prototype.onTimeout_=function(){this.stopTimer_(),this.completeInternal()},e}(t.Abstract);t.Sleep=e})(tr||(tr={}));var tr;(function(t){var e=function(e){function r(t,r){e.call(this,r||"StopOnSuccess"),this.completedTasks_=[],this.erroredTasks_=[],this.taskQueue_=[],this.taskQueueIndex_=0,t&&this.addAll(t)}return __extends(r,e),r.prototype.addAll=function(t){for(var e=0;t.length>e;e++)this.add(t[e]);return this},r.prototype.add=function(e){if(this.getState()===t.enums.State.RUNNING)throw Error("Cannot add task while running.");var r=this.taskQueue_.indexOf(e);if(r>=0)throw"Cannot add task more than once.";return this.taskQueue_.push(e),this},r.prototype.remove=function(e){if(this.getState()===t.enums.State.RUNNING)throw Error("Cannot remove  task while running.");var r=this.taskQueue_.indexOf(e);if(0>r)throw Error("Attempted to remove an invalid task.");return this.removeCallbacks_(e),this.taskQueue_.splice(this.taskQueue_.indexOf(e),1),this},r.prototype.getCompletedOperationsCount=function(){if(this.getState()===t.enums.State.COMPLETED)return this.getOperationsCount();var e=0;return this.eachTaskInQueue_(function(t){e+=t.getCompletedOperationsCount()}),e},r.prototype.getOperationsCount=function(){var t=0;return this.eachTaskInQueue_(function(e){t+=e.getOperationsCount()}),t},r.prototype.runImpl=function(){if(this.allTasksAreCompleted_())this.completeInternal();else{this.erroredTasks_=[];var t=this.taskQueue_[this.taskQueueIndex_];this.addCallbacks_(t),t.run()}},r.prototype.interruptImpl=function(){this.eachTaskInQueue_(function(e){e.getState()==t.enums.State.RUNNING&&e.interrupt()})},r.prototype.resetImpl=function(){this.taskQueueIndex_=0,this.completedTasks_=[],this.erroredTasks_=[],this.eachTaskInQueue_(function(t){t.reset()})},r.prototype.addCallbacks_=function(t){t.completed(this.childTaskCompleted_,this),t.errored(this.childTaskErrored_,this)},r.prototype.allTasksAreCompleted_=function(){for(var e=0;this.taskQueue_.length>e;e++){var r=this.taskQueue_[e];if(r.getState()!=t.enums.State.COMPLETED)return!1}return!0},r.prototype.checkForTaskCompletion_=function(){if(this.completedTasks_.length>0)this.completeInternal();else{var t=this.completedTasks_.length+this.erroredTasks_.length;t>=this.taskQueue_.length&&(this.erroredTasks_.length>0?this.errorInternal():this.completeInternal())}},r.prototype.childTaskCompleted_=function(t){this.completedTasks_.push(t),this.taskCompletedOrRemoved_(t)},r.prototype.childTaskErrored_=function(t){this.erroredTasks_.push(t),this.taskCompletedOrRemoved_(t)},r.prototype.eachTaskInQueue_=function(t){for(var e=0;this.taskQueue_.length>e;e++){var r=this.taskQueue_[e];t(r)}},r.prototype.removeCallbacks_=function(e){e.off(t.enums.Event.COMPLETED,this.childTaskCompleted_,this),e.off(t.enums.Event.ERRORED,this.childTaskErrored_,this)},r.prototype.taskCompletedOrRemoved_=function(){if(this.taskQueueIndex_++,this.getState()==t.enums.State.RUNNING&&(this.checkForTaskCompletion_(),this.getState()==t.enums.State.RUNNING)){var e=this.taskQueue_[this.taskQueueIndex_];e&&(this.addCallbacks_(e),e.run())}},r}(t.Abstract);t.StopOnSuccess=e})(tr||(tr={}));var tr;(function(t){var e=function(t){function e(e,r){t.call(this,function(){},e,r||"Stub")
}return __extends(e,t),e}(t.Closure);t.Stub=e})(tr||(tr={}));var tr;(function(t){var e=function(e){function r(t,r,s){e.call(this,s||"Timeout"),this.timeoutPause_=-1,this.timeoutStart_=-1,this.decoratedTask_=t,this.timeout_=r}return __extends(r,e),r.prototype.getDecoratedTask=function(){return this.decoratedTask_},r.prototype.interruptImpl=function(){this.stopTimer_(),this.removeCallbacks_(),this.decoratedTask_.interrupt(),this.timeoutPause_=(new Date).getTime()},r.prototype.resetImpl=function(){this.stopTimer_(),this.removeCallbacks_(),this.decoratedTask_.reset(),this.timeoutStart_=-1,this.timeoutPause_=-1},r.prototype.runImpl=function(){if(this.timeoutId_)throw"A timeout for this task already exists.";var e=this.timeout_;this.timeoutStart_>-1&&this.timeoutPause_>-1&&(e+=this.timeoutStart_-this.timeoutPause_),e=Math.max(e,0),this.timeoutId_=setTimeout(this.onTimeout_.bind(this),e),this.timeoutStart_=(new Date).getTime(),this.decoratedTask_.getState()==t.enums.State.COMPLETED?this.onDecoratedTaskCompleted_(this.decoratedTask_):this.decoratedTask_.getState()==t.enums.State.ERRORED?this.onDecoratedTaskErrored_(this.decoratedTask_):(this.decoratedTask_.completed(this.onDecoratedTaskCompleted_,this),this.decoratedTask_.errored(this.onDecoratedTaskErrored_,this),this.decoratedTask_.run())},r.prototype.onDecoratedTaskCompleted_=function(t){this.stopTimer_(),this.removeCallbacks_(),this.completeInternal(t.getData())},r.prototype.onDecoratedTaskErrored_=function(t){this.stopTimer_(),this.removeCallbacks_(),this.errorInternal(t.getData(),t.getErrorMessage())},r.prototype.onTimeout_=function(){this.stopTimer_(),this.removeCallbacks_(),this.decoratedTask_.interrupt(),this.errorInternal(this.decoratedTask_.getData(),"Task timed out after "+this.timeout_+"ms")},r.prototype.removeCallbacks_=function(){this.decoratedTask_.off(t.enums.Event.COMPLETED,this.onDecoratedTaskCompleted_,this),this.decoratedTask_.off(t.enums.Event.ERRORED,this.onDecoratedTaskErrored_,this)},r.prototype.stopTimer_=function(){this.timeoutId_&&(clearTimeout(this.timeoutId_),this.timeoutId_=null)},r}(t.Abstract);t.Timeout=e})(tr||(tr={}));var tr;(function(t){var e=function(t){function e(e,r,s,n){if(t.call(this,n||"Tween"),this.elapsed_=0,this.lastUpdateTimestamp_=0,isNaN(r)||0>=r)throw Error("Invalid tween duration provided.");this.callback_=e,this.duration_=r,this.easingFunction_=s||this.linearEase_}return __extends(e,t),e.prototype.interruptImpl=function(){this.cancelCurrentAnimationFrame_()},e.prototype.resetImpl=function(){this.elapsed_=0,this.lastUpdateTimestamp_=0,this.queueAnimationFrame_(this.updateReset_.bind(this))},e.prototype.runImpl=function(){this.lastUpdateTimestamp_=(new Date).getTime(),this.queueAnimationFrame_(this.updateRunning_.bind(this))},e.prototype.cancelCurrentAnimationFrame_=function(){this.animationFrameId_&&(window.cancelAnimationFrame(this.animationFrameId_),this.animationFrameId_=null)},e.prototype.linearEase_=function(t){return t},e.prototype.queueAnimationFrame_=function(t){this.cancelCurrentAnimationFrame_(),this.animationFrameId_=window.requestAnimationFrame(t)},e.prototype.updateReset_=function(){this.animationFrameId_=null,this.callback_(this.easingFunction_(0))},e.prototype.updateRunning_=function(){var t=(new Date).getTime();this.animationFrameId_=null,this.elapsed_+=t-this.lastUpdateTimestamp_,this.lastUpdateTimestamp_=t;var e=this.easingFunction_(Math.min(1,this.elapsed_/this.duration_));this.callback_(e),this.elapsed_>=this.duration_?this.completeInternal():this.queueAnimationFrame_(this.updateRunning_.bind(this))},e}(t.Abstract);t.Tween=e})(tr||(tr={}));var tr;(function(t){var e=function(e){function r(s,n,i,o){e.call(this,o||"Xhr"),this.postData_=n,this.responseType_=i||r.DEFAULT_RESPONSE_TYPE||t.enums.XhrResponseType.TEXT,this.url_=s}return __extends(r,e),r.setDefaultResponseType=function(t){this.DEFAULT_RESPONSE_TYPE=t},r.prototype.getResponseType=function(){return this.responseType_},r.prototype.interruptImpl=function(){void 0!==this.xhr_&&(this.xhr_.abort(),this.xhr_=void 0)},r.prototype.resetImpl=function(){this.xhr_=void 0},r.prototype.runImpl=function(){try{var e=void 0===r?"GET":"POST",r=this.createPostDataString_();this.xhr_=new XMLHttpRequest,this.xhr_.addEventListener("load",this.onXhrRequestSuccess_.bind(this)),this.xhr_.addEventListener("abort",this.onXhrRequestErrorOrTimeout_.bind(this)),this.xhr_.addEventListener("error",this.onXhrRequestErrorOrTimeout_.bind(this)),this.xhr_.addEventListener("timeout",this.onXhrRequestErrorOrTimeout_.bind(this)),this.xhr_.open(e,this.url_,!0),this.xhr_.send(r)}catch(s){this.getState()===t.enums.State.RUNNING&&this.errorInternal(s,s.message)}},r.prototype.createPostDataString_=function(){return void 0!==this.postData_?this.serialize(this.postData_):void 0},r.prototype.serialize=function(t,e){var r=[];for(var s in t)if(t.hasOwnProperty(s)){var n=e?e+"["+s+"]":s,i=t[s];r.push("object"==typeof i?this.serialize(i,n):encodeURIComponent(n)+"="+encodeURIComponent(i))}return r.join("&")},r.prototype.onXhrRequestSuccess_=function(){if(this.getState()===t.enums.State.RUNNING)try{var e;switch(this.responseType_){case t.enums.XhrResponseType.JSON:e=JSON.parse(this.xhr_.responseText);break;case t.enums.XhrResponseType.TEXT:e=this.xhr_.responseText;break;case t.enums.XhrResponseType.XML:e=this.xhr_.responseXML}this.completeInternal(e)}catch(r){this.errorInternal(r,"Invalid response")}},r.prototype.onXhrRequestErrorOrTimeout_=function(){this.getState()===t.enums.State.RUNNING&&this.errorInternal(this.xhr_.status,this.xhr_.statusText)},r}(t.Abstract);t.Xhr=e})(tr||(tr={}));var tr;(function(t){var e;(function(t){(function(t){t[t.STARTED="STARTED"]="STARTED",t[t.INTERRUPTED="INTERRUPTED"]="INTERRUPTED",t[t.COMPLETED="COMPLETED"]="COMPLETED",t[t.ERRORED="ERRORED"]="ERRORED",t[t.FINAL="FINAL"]="FINAL"})(t.Event||(t.Event={})),t.Event})(e=t.enums||(t.enums={}))})(tr||(tr={}));var tr;(function(t){var e;(function(t){(function(t){t[t.INITIALIZED="INITIALIZED"]="INITIALIZED",t[t.RUNNING="RUNNING"]="RUNNING",t[t.INTERRUPTED="INTERRUPTED"]="INTERRUPTED",t[t.COMPLETED="COMPLETED"]="COMPLETED",t[t.ERRORED="ERRORED"]="ERRORED"})(t.State||(t.State={})),t.State})(e=t.enums||(t.enums={}))})(tr||(tr={}));var tr;(function(t){var e;(function(t){(function(t){t[t.JSON="JSON"]="JSON",t[t.TEXT="TEXT"]="TEXT",t[t.XML="XML"]="XML"})(t.XhrResponseType||(t.XhrResponseType={})),t.XhrResponseType})(e=t.enums||(t.enums={}))})(tr||(tr={}));
return tr;
}));
